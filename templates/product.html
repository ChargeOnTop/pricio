{% extends "base.html" %}

{% block title %}{{ product.name }}{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        font-size: 0.875rem;
        color: var(--text-light);
        margin-bottom: 1rem;
    }
    
    .breadcrumb a {
        color: var(--text-light);
        text-decoration: none;
    }
    
    .breadcrumb a:hover {
        color: var(--primary);
    }
    
    .product-header {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 2rem;
        align-items: start;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
        .product-header {
            grid-template-columns: 1fr;
        }
    }
    
    .product-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .product-category {
        color: var(--text-light);
        font-size: 0.875rem;
    }
    
    .price-card {
        background: var(--bg);
        border: 2px solid var(--primary);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        min-width: 200px;
    }
    
    .current-price {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary-dark);
    }
    
    .current-price small {
        font-size: 1.25rem;
        font-weight: 400;
    }
    
    .price-range {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 0.75rem;
        font-size: 0.875rem;
        color: var(--text-light);
    }
    
    .price-min { color: #16a34a; }
    .price-max { color: #dc2626; }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .action-buttons .btn {
        flex: 1;
    }
    
    .btn-favorite.active {
        background: #fef2f2;
        border-color: #fecaca;
        color: #dc2626;
    }
    
    .btn-alert.active {
        background: #dcfce7;
        border-color: #bbf7d0;
        color: #16a34a;
    }
    
    .section-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    @media (max-width: 900px) {
        .section-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .chart-container {
        height: 250px;
    }
    
    .history-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }
    
    .history-table th,
    .history-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }
    
    .history-table th {
        font-weight: 600;
        color: var(--text-light);
    }
    
    .similar-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        border-radius: var(--radius);
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
    }
    
    .similar-item:hover {
        background: var(--bg-secondary);
    }
    
    .similar-info {
        flex: 1;
        min-width: 0;
    }
    
    .similar-name {
        font-weight: 500;
        font-size: 0.875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .similar-meta {
        font-size: 0.75rem;
        color: var(--text-light);
    }
    
    .similar-price {
        font-weight: 600;
        white-space: nowrap;
    }
    
    .price-diff {
        font-size: 0.75rem;
        margin-top: 0.125rem;
    }
    
    .price-diff.cheaper { color: #16a34a; }
    .price-diff.expensive { color: #dc2626; }
    
    .compare-card {
        background: linear-gradient(135deg, var(--bg-secondary), #dcfce7);
        border: 1px solid #bbf7d0;
    }
    
    .compare-store {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--bg);
        border-radius: var(--radius);
        margin-top: 1rem;
        text-decoration: none;
        color: inherit;
    }
    
    .compare-store:hover {
        box-shadow: var(--shadow);
    }
    
    .compare-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
    }
    
    .compare-icon.magnit { background: #e31e24; }
    .compare-icon.pyaterochka { background: #e30613; }
    
    .attrs-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .attr-tag {
        padding: 0.375rem 0.75rem;
        background: var(--bg-secondary);
        border-radius: 20px;
        font-size: 0.8rem;
        color: var(--text-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">–ì–ª–∞–≤–Ω–∞—è</a> / 
    <a href="/store/{{ store_id }}">{{ store_name }}</a> / 
    {{ product.name[:50] }}...
</div>

<div class="product-header">
    <div>
        <h1 class="product-title">{{ product.name }}</h1>
        <div class="product-category">
            {% if product.category %}{{ product.category }}{% endif %}
            {% if product.brand %} ‚Ä¢ {{ product.brand }}{% endif %}
        </div>
        
        {% if product.weight_g or product.volume_ml %}
        <div class="attrs-grid">
            {% if product.weight_g %}<span class="attr-tag">‚öñÔ∏è {{ product.weight_g }} –≥</span>{% endif %}
            {% if product.volume_ml %}<span class="attr-tag">üíß {{ product.volume_ml }} –º–ª</span>{% endif %}
            {% if product.product_type %}<span class="attr-tag">üì¶ {{ product.product_type }}</span>{% endif %}
        </div>
        {% endif %}
    </div>
    
    <div class="price-card">
        <div class="current-price">{{ "%.0f"|format(product.current_price) }}<small>.{{ "%02d"|format((product.current_price * 100) % 100) }} ‚ÇΩ</small></div>
        <div class="price-range">
            <span class="price-min">‚Üì {{ "%.2f"|format(product.min_price) }} ‚ÇΩ</span>
            <span class="price-max">‚Üë {{ "%.2f"|format(product.max_price) }} ‚ÇΩ</span>
        </div>
        
        {% if user %}
        <div class="action-buttons">
            <button id="btn-favorite" class="btn btn-secondary btn-favorite {% if is_favorite %}active{% endif %}" onclick="toggleFavorite()">
                <span id="fav-icon">{{ '‚ù§Ô∏è' if is_favorite else 'ü§ç' }}</span>
                <span id="fav-text">{{ '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' if is_favorite else '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' }}</span>
            </button>
            <button id="btn-alert" class="btn btn-secondary btn-alert {% if has_alert %}active{% endif %}" onclick="toggleAlert()">
                <span id="alert-icon">{{ 'üîî' if has_alert else 'üîï' }}</span>
                <span id="alert-text">{{ '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è' if has_alert else '–°–ª–µ–¥–∏—Ç—å' }}</span>
            </button>
        </div>
        {% else %}
        <div class="action-buttons">
            <a href="/login" class="btn btn-secondary">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="section-grid">
    <!-- Price History Chart -->
    <div class="card">
        <h2 class="card-title">üìà –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω</h2>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    
    <!-- Compare with other store -->
    <div class="card compare-card">
        <h2 class="card-title">üí∞ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h2>
        {% if comparison %}
        <p style="color: var(--text-light); font-size: 0.875rem;">
            –ü–æ—Ö–æ–∂–∏–π —Ç–æ–≤–∞—Ä –≤ {{ '–ú–∞–≥–Ω–∏—Ç–µ' if store_id == '5ka' else '–ü—è—Ç—ë—Ä–æ—á–∫–µ' }}:
        </p>
        <a href="/store/{{ comparison.store_id }}/product/{{ comparison.product_id }}" class="compare-store">
            <div class="compare-icon {{ 'magnit' if comparison.store_id == 'magnit' else 'pyaterochka' }}">
                {{ '–ú' if comparison.store_id == 'magnit' else '5' }}
            </div>
            <div class="similar-info">
                <div class="similar-name">{{ comparison.name }}</div>
                <div class="similar-meta">{{ comparison.store_name }}</div>
            </div>
            <div>
                <div class="similar-price">{{ "%.2f"|format(comparison.current_price) }} ‚ÇΩ</div>
                {% set diff = comparison.current_price - product.current_price %}
                <div class="price-diff {{ 'cheaper' if diff < 0 else 'expensive' }}">
                    {{ '+' if diff > 0 else '' }}{{ "%.0f"|format(diff) }} ‚ÇΩ
                </div>
            </div>
        </a>
        {% else %}
        <p style="color: var(--text-light);">–ü–æ—Ö–æ–∂–∏–π —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ</p>
        {% endif %}
    </div>
</div>

<div class="section-grid" style="margin-top: 1.5rem;">
    <!-- Similar Products -->
    <div class="card">
        <h2 class="card-title">üîÑ –ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã</h2>
        {% if similar_products %}
        <div>
            {% for item in similar_products[:5] %}
            <a href="/store/{{ store_id }}/product/{{ item.product_id }}" class="similar-item">
                <div class="similar-info">
                    <div class="similar-name">{{ item.name }}</div>
                    <div class="similar-meta">
                        {% if item.match_score %}–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: {{ item.match_score }}%{% endif %}
                    </div>
                </div>
                <div>
                    <div class="similar-price">{{ "%.2f"|format(item.current_price) }} ‚ÇΩ</div>
                    {% set diff = item.current_price - product.current_price %}
                    {% if diff != 0 %}
                    <div class="price-diff {{ 'cheaper' if diff < 0 else 'expensive' }}">
                        {{ '+' if diff > 0 else '' }}{{ "%.0f"|format(diff) }} ‚ÇΩ
                    </div>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p style="color: var(--text-light);">–ü–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% endif %}
    </div>
    
    <!-- Price History Table -->
    <div class="card">
        <h2 class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
        {% if price_history %}
        <table class="history-table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                </tr>
            </thead>
            <tbody>
                {% for record in price_history[:10] %}
                <tr>
                    <td>{{ record.recorded_at[:16] if record.recorded_at else '‚Äî' }}</td>
                    <td><strong>{{ "%.2f"|format(record.price) }} ‚ÇΩ</strong></td>
                    <td>
                        {% if record.old_price %}
                            {% set change = record.price - record.old_price %}
                            <span class="{{ 'price-diff cheaper' if change < 0 else 'price-diff expensive' }}">
                                {{ '+' if change > 0 else '' }}{{ "%.2f"|format(change) }} ‚ÇΩ
                            </span>
                        {% else %}
                            <span style="color: var(--text-light);">–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: var(--text-light);">–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const storeId = '{{ store_id }}';
const productId = '{{ product.product_id }}';

// Price Chart
const ctx = document.getElementById('priceChart').getContext('2d');
const priceData = {{ price_history_json|safe if price_history_json else '[]' }};

new Chart(ctx, {
    type: 'line',
    data: {
        labels: priceData.map(p => p.date),
        datasets: [{
            label: '–¶–µ–Ω–∞',
            data: priceData.map(p => p.price),
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#22c55e'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: value => value + ' ‚ÇΩ'
                }
            }
        }
    }
});

// Favorite toggle
async function toggleFavorite() {
    const btn = document.getElementById('btn-favorite');
    const icon = document.getElementById('fav-icon');
    const text = document.getElementById('fav-text');
    const isActive = btn.classList.contains('active');
    
    const response = await fetch(`/api/favorites/${storeId}/${productId}`, {
        method: isActive ? 'DELETE' : 'POST'
    });
    
    if (response.ok) {
        btn.classList.toggle('active');
        icon.textContent = isActive ? 'ü§ç' : '‚ù§Ô∏è';
        text.textContent = isActive ? '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º';
    }
}

// Alert toggle
async function toggleAlert() {
    const btn = document.getElementById('btn-alert');
    const icon = document.getElementById('alert-icon');
    const text = document.getElementById('alert-text');
    const isActive = btn.classList.contains('active');
    
    const response = await fetch(`/api/alerts/${storeId}/${productId}`, {
        method: isActive ? 'DELETE' : 'POST'
    });
    
    if (response.ok) {
        btn.classList.toggle('active');
        icon.textContent = isActive ? 'üîï' : 'üîî';
        text.textContent = isActive ? '–°–ª–µ–¥–∏—Ç—å' : '–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è';
    }
}
</script>
{% endblock %}
